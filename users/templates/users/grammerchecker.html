{% extends 'users/base.html' %}
{% load static %}
{% block content %}

<style>
    .comparison-container {
        display: flex;
        justify-content: space-between;
    }

    .column {
        width: 48%;
    }
</style>

<div class="container">
    <nav aria-label="breadcrumb mt-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'feedback' %}">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Pronunciation and Grammar errors</li>
        </ol>
    </nav>
    <div class="card text-center mt-5 shadow-lg p-3 bg-white rounded" style="width: 90%;margin: auto;">
        <h4 class="card-title mb-0">Detecting Grammar</h4>
        <div id="content" class="comparison-container"></div>
    </div>

    <div class="modal fade" id="progress-modal" tabindex="-1" role="dialog" aria-labelledby="modal-header"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-header"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-center mt-5" id="spinner-box">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- <script id="django-data" type="application/json"> {{ data|safe }} </script> -->
<script>
    function displayData(data) {
        const contentDiv = document.getElementById('content');
        let originalHtml = '<div class="column">';
        let correctedHtml = '<div class="column">';

        originalHtml += `<h5 class="mt-4">${"Original".charAt(0).toUpperCase() + "Original".slice(1)}</h5>`;
        correctedHtml += `<h5 class="mt-4">${"Corrected".charAt(0).toUpperCase() + "Corrected".slice(1)}</h5>`;

        for (const pageNum of Object.keys(data.original)) {
            const originalContent = data.original[pageNum];
            const correctedContent = data.corrected[pageNum];

            originalHtml += `
                    <div class="card mb-3">
                        <div class="card-header">Page ${pageNum}</div>
                        <div class="card-body">
                            <h6 class="card-title">${originalContent.title}</h6>
                            <p class="card-text">${originalContent.body}</p>
                        </div>
                    </div>
                `;

            correctedHtml += `
                    <div class="card mb-3">
                        <div class="card-header">Page ${pageNum}</div>
                        <div class="card-body">
                            <h6 class="card-title">${correctedContent.title}</h6>
                            <p class="card-text">${correctedContent.body}</p>
                        </div>
                    </div>
                `;
        }

        originalHtml += '</div>';
        correctedHtml += '</div>';

        contentDiv.innerHTML = originalHtml + correctedHtml;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Check if this cookie string begins with the name we want
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const spinnermodal = new bootstrap.Modal(document.getElementById('progress-modal'));
        const spinner = document.getElementById('spinner-box');
        const spinnerheader = document.getElementById('modal-header');
        const spinnerbox = document.getElementById("spinner-box");
        const data = document.getElementById("pronounciation");
        // const maxEmotion = document.getElementById("max-emotion");
        // spinnerbox.style.display = 'flex';

        var xhr = new XMLHttpRequest();

        // Configure it: POST-request for the URL /post
        xhr.open('POST', "{% url 'grammer' %}", true);
        // Set up the request headers
        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

        spinnerheader.innerText = "Processing Presentation for Grammar and Spelling Errors"
        spinnermodal.show()

        // Define what happens on successful data submission
        xhr.onload = function () {
            if (xhr.status === 200) {
                console.log('Response received:', xhr.responseText);
                spinnerbox.style.display = 'none';
                spinnerheader.innerText = "Processing Presentation for Grammar and Spelling Errors completed"
                spinnermodal.hide()
                var response = JSON.parse(xhr.responseText); // Parse the JSON response

                displayData(response);
            } else {
                console.error('Error:', xhr.statusText);
                spinnerbox.style.display = 'none';
                spinnerheader.innerText = "Processing Presentation for Grammar and Spelling Errors failed."
            }
        };

        // Define what happens in case of error
        xhr.onerror = function (error) {
            console.error('Request failed: ', error);
            spinnerbox.style.display = 'none';
            spinnerheader.innerText = "Processing Presentation for Grammar and Spelling Errors failed."
        };

        // Send the request
        xhr.send();
    });
</script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/js/bootstrap.min.js"></script>

{% endblock content %}