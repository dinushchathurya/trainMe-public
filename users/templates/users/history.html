{% extends 'users/base.html' %}
{% load static %}
{% block content %}

<style>
    .video-wrap {
        position: relative;
        padding-bottom: 56.25%;
        /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
    }

    .video-wrap video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
</style>
<div class="container" style="width: 80%;">
    <nav aria-label="breadcrumb mt-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">History</li>
        </ol>
    </nav>

    <div class="heading-text heading-line text-center mt-5">
        <h4>My Video History</h4>
    </div>

    <form id="compareVideosForm" method="GET" action="{% url 'compare_videos' %}">
        {% csrf_token %}
        <div class="d-flex">
            <div class="col-12">
                <div id="modalVideo" style="max-width: 100%; min-height:380px">
                    <div class="p-t-30 text-center">
                        {% if videos|length > 0 %}
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">
                                        <h1 class="mb-2">Select</h1>
                                    </th>
                                    <th style="width: 100%;">
                                        <h1 class="mb-2">Video Preview</h1>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for x in videos %}
                                <tr>
                                    <td class="text-center" style="align-content: center;">
                                        <input type="checkbox" id="video-checkbox-{{ x.id }}" name="video-checkbox"
                                            class="limited-video-checkbox video-select" data-video-id="{{ x.id }}">
                                        <h4 class="mb-2">Compare</h4>
                                    </td>
                                    <td>
                                        <h4 class="mb-2">Video Review: Caption {{ x.caption }}</h4>
                                        <div class="video-wrap">
                                            <video id="video-js-{{ x.id }}" class="video-js" controls preload="metadata"
                                                width="100%" height="225">
                                                <source src="{{x.video.url}}" type="video/mp4" />
                                                <source src="{{x.video.url}}" type="video/webm" />
                                                Your browser does not support the video tag.
                                            </video>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="video-item">
                            <h2 class="mb-3">No video feedback history yet.</h2>
                            <div class="video-wrap m-b-20">
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-center mb-5">
            <div class="d-flex justify-content-center mb-5">
                <button class="btn btn-primary" id="sendSelectedVideos" type="submit">Compare Videos</button>
            </div>
        </div>
    </form>


    <div class="heading-text heading-line text-center mt-5">
        <h4>My Presentations History</h4>
    </div>

    <form id="comparePresentationsForm" method="GET" action="{% url 'compare_ppts' %}">
        <div id="modalPresentationPreview" style="max-width: 100%; min-height:380px">
            <div class="p-t-30 text-center">
                {% if ppts|length > 0 %}
                {% csrf_token %}
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 30%;">
                                <h1 class="mb-2">Select</h1>
                            </th>
                            <th style="width: 100%;">
                                <h1 class="mb-2">Presentation Preview</h1>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for x in ppts %}
                        <tr>
                            <td class="text-center" style="align-content: center;">
                                <input type="checkbox" id="presentation-checkbox-{{ x.id }}"
                                    name="presentation-checkbox" data-ppt-id="{{ x.id }}"
                                    class="limited-presentation-checkbox presentation-select">
                                <h4 class="mb-2">Compare</h4>
                            </td>
                            <td>
                                <div class="presentation-item" style="align-content: center;">
                                    <h2 class="mb-3">PowerPoint Review: Caption {{ x.caption }}</h2>
                                    <div class="presentation-wrap m-b-20">
                                        <embed src="{{ x.pdf.url }}" type="application/pdf" width="100%"
                                            height="375px" />
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="presentation-item">
                    <h2 class="mb-3">No presentation feedback history yet.</h2>
                    <div class="presentation-wrap m-b-20"></div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="d-flex justify-content-center mb-5">
            <button class="btn btn-primary" id="sendSelectedPpts" type="submit">Compare Presentations</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const limitedVideoCheckboxes = document.querySelectorAll('.limited-video-checkbox');
        const limitedPptCheckboxes = document.querySelectorAll('.limited-video-checkbox');
        const limit = 2;
        const compareVideosForm = document.getElementById('compareVideosForm');
        const comparePresentationsForm  = document.getElementById('comparePresentationsForm')
        const sendSelectedVideosButton = document.getElementById('sendSelectedVideos');
        const sendSelectedPptsButton = document.getElementById('sendSelectedPpts');

        limitedVideoCheckboxes.forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                const checkedCheckboxes = document.querySelectorAll('.limited-video-checkbox:checked');

                if (checkedCheckboxes.length > limit) {
                    this.checked = false;
                    alert('You can only select up to ' + limit + ' items for comparison.');
                }
            });
        });


        limitedPptCheckboxes.forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                const checkedCheckboxes = document.querySelectorAll('.limited-presentation-checkbox:checked');

                if (checkedCheckboxes.length > limit) {
                    this.checked = false;
                    alert('You can only select up to ' + limit + ' items for comparison.');
                }
            });
        });

        sendSelectedVideosButton.addEventListener('click', function (e) {
            e.preventDefault();
            const selectedVideos = document.querySelectorAll('.video-select:checked');
            if (selectedVideos.length < limit) {
                alert('Please select at least two videos to compare.');
                return;
            }

            const videoIds = Array.from(selectedVideos).map(checkbox => checkbox.dataset.videoId);
            const queryString = videoIds.map(id => `video_id=${id}`).join('&');

            window.location.href = `{% url 'compare_videos' %}?${queryString}`;
        });

        sendSelectedPptsButton.addEventListener('click', function (e) {
            e.preventDefault();
            const selectedVideos = document.querySelectorAll('.presentation-select:checked');
            if (selectedVideos.length < limit) {
                alert('Please select at least two videos to compare.');
                return;
            }

            const pptIds = Array.from(selectedVideos).map(checkbox => checkbox.dataset.pptId);
            const queryString = pptIds.map(id => `ppt_id=${id}`).join('&');

            window.location.href = `{% url 'compare_ppts' %}?${queryString}`;
        });
    });
</script>

{% endblock content %}